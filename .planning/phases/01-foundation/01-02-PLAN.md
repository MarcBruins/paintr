---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/auth.ts
  - src/lib/auth-client.ts
  - src/lib/db/schema/auth.ts
  - src/lib/db/schema/index.ts
  - src/app/api/auth/[...all]/route.ts
  - src/proxy.ts
  - src/app/(auth)/sign-in/page.tsx
  - src/app/(auth)/sign-up/page.tsx
  - src/app/(auth)/layout.tsx
  - src/app/(app)/layout.tsx
  - src/app/(app)/dashboard/page.tsx
autonomous: true
requirements:
  - AUTH-01
  - AUTH-02
must_haves:
  truths:
    - "A user can register with email and password via the sign-up page"
    - "A user can sign in with their credentials and is redirected to the dashboard"
    - "Session persists across browser refresh without re-entering credentials"
    - "Unauthenticated users are redirected to sign-in page"
    - "Auth schema tables exist in the database after migration"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Better Auth server instance with emailAndPassword enabled"
      contains: "emailAndPassword"
    - path: "src/lib/auth-client.ts"
      provides: "Better Auth browser client"
      contains: "createAuthClient"
    - path: "src/app/api/auth/[...all]/route.ts"
      provides: "Better Auth catch-all API handler"
      contains: "toNextJsHandler"
    - path: "src/proxy.ts"
      provides: "Next.js 16 proxy route guard"
      contains: "export function proxy"
    - path: "src/app/(auth)/sign-in/page.tsx"
      provides: "Sign-in page with email/password form"
    - path: "src/app/(auth)/sign-up/page.tsx"
      provides: "Sign-up page with email/password form"
    - path: "src/app/(app)/layout.tsx"
      provides: "Protected layout with server-side session check"
      contains: "auth.api.getSession"
    - path: "src/lib/db/schema/auth.ts"
      provides: "Better Auth generated schema tables"
  key_links:
    - from: "src/app/api/auth/[...all]/route.ts"
      to: "src/lib/auth.ts"
      via: "auth import"
      pattern: "import.*auth.*from.*@/lib/auth"
    - from: "src/app/(app)/layout.tsx"
      to: "src/lib/auth.ts"
      via: "getSession server call"
      pattern: "auth\\.api\\.getSession"
    - from: "src/proxy.ts"
      to: "better-auth.session_token"
      via: "cookie presence check"
      pattern: "better-auth\\.session_token"
    - from: "src/app/(auth)/sign-in/page.tsx"
      to: "src/lib/auth-client.ts"
      via: "signIn client call"
      pattern: "signIn\\.email"
---

<objective>
Configure Better Auth with email/password authentication, generate the auth schema, create sign-in and sign-up pages, and set up the protected app layout with session gating.

Purpose: Users need to create accounts and sign in before any organization or quote features can work. This plan delivers AUTH-01 (account creation) and AUTH-02 (session persistence).
Output: Working sign-up/sign-in flow with session-gated dashboard, auth schema migrated to Supabase.
</objective>

<execution_context>
@C:/Users/MarcBruins/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/MarcBruins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Better Auth server and client, generate auth schema, and run migration</name>
  <files>
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/lib/db/schema/auth.ts
    src/lib/db/schema/index.ts
    src/app/api/auth/[...all]/route.ts
  </files>
  <action>
    1. Create `src/lib/auth.ts` — the Better Auth server instance. For THIS plan, configure emailAndPassword only. The organization plugin will be added in Plan 03. Use this initial config:
       ```typescript
       import { betterAuth } from "better-auth";
       import { drizzleAdapter } from "better-auth/adapters/drizzle";
       import { nextCookies } from "better-auth/next-js";
       import { db } from "./db";

       export const auth = betterAuth({
         database: drizzleAdapter(db, { provider: "pg" }),
         emailAndPassword: { enabled: true },
         plugins: [
           nextCookies(), // MUST be last plugin
         ],
         session: {
           cookieCache: {
             enabled: true,
             maxAge: 5 * 60, // 5 minutes
           },
         },
       });

       export type Session = typeof auth.$Infer.Session;
       ```

    2. Create `src/lib/auth-client.ts` — the browser client:
       ```typescript
       import { createAuthClient } from "better-auth/react";

       export const authClient = createAuthClient({
         baseURL: process.env.NEXT_PUBLIC_APP_URL,
       });

       export const { signIn, signUp, signOut, useSession } = authClient;
       ```
       Note: organizationClient plugin will be added in Plan 03.

    3. Create `src/app/api/auth/[...all]/route.ts`:
       ```typescript
       import { auth } from "@/lib/auth";
       import { toNextJsHandler } from "better-auth/next-js";

       export const { GET, POST } = toNextJsHandler(auth);
       ```

    4. Generate the Better Auth schema:
       ```bash
       npx @better-auth/cli@latest generate --output src/lib/db/schema/auth.ts
       ```
       This creates the auth tables (user, session, account, verification). Do NOT hand-edit the output.

    5. Update `src/lib/db/schema/index.ts` to re-export both schemas:
       ```typescript
       export * from "./auth";
       export * from "./app";
       ```

    6. Generate and run the Drizzle migration:
       ```bash
       pnpm db:generate
       pnpm db:migrate
       ```
       This creates all auth tables AND the quotes table in Supabase.

    7. After migration, enable RLS on the quotes table. Run via Supabase SQL (through Drizzle migration or direct SQL):
       ```bash
       pnpm drizzle-kit push
       ```
       If RLS policies defined in Drizzle schema are not applied automatically, note this for manual application in Plan 03.

    IMPORTANT: The `nextCookies()` plugin MUST be the last entry in the plugins array. If it is not last, session cookies will not be set after sign-in/sign-up.
  </action>
  <verify>
    Run `pnpm db:generate` to verify schema generation succeeds. Run `pnpm exec tsc --noEmit` to confirm no type errors. Check that `src/lib/db/schema/auth.ts` was generated and contains user/session/account tables.
  </verify>
  <done>Better Auth server instance configured with emailAndPassword, auth schema generated and migrated to Supabase, catch-all API route handler mounted at /api/auth/*.</done>
</task>

<task type="auto">
  <name>Task 2: Create auth UI pages, proxy route guard, and protected app layout</name>
  <files>
    src/proxy.ts
    src/app/(auth)/layout.tsx
    src/app/(auth)/sign-in/page.tsx
    src/app/(auth)/sign-up/page.tsx
    src/app/(app)/layout.tsx
    src/app/(app)/dashboard/page.tsx
  </files>
  <action>
    1. Create `src/proxy.ts` — Next.js 16 proxy (NOT middleware.ts):
       ```typescript
       import { NextRequest, NextResponse } from "next/server";

       export function proxy(request: NextRequest) {
         const sessionCookie = request.cookies.get("better-auth.session_token");
         const isAuthRoute = request.nextUrl.pathname.startsWith("/sign-");
         const isApiRoute = request.nextUrl.pathname.startsWith("/api/");
         const isRootRoute = request.nextUrl.pathname === "/";

         if (!sessionCookie && !isAuthRoute && !isApiRoute && !isRootRoute) {
           return NextResponse.redirect(new URL("/sign-in", request.url));
         }

         return NextResponse.next();
       }

       export const config = {
         matcher: ["/((?!_next/static|_next/image|favicon.ico).*)"],
       };
       ```
       CRITICAL: File must be named `proxy.ts` and export function must be named `proxy`. Using `middleware.ts` is deprecated in Next.js 16.

    2. Create `src/app/(auth)/layout.tsx` — a centered layout for auth pages:
       ```tsx
       export default function AuthLayout({ children }: { children: React.ReactNode }) {
         return (
           <div className="flex min-h-screen items-center justify-center bg-gray-50 px-4">
             <div className="w-full max-w-md">{children}</div>
           </div>
         );
       }
       ```

    3. Create `src/app/(auth)/sign-up/page.tsx` — sign-up form using Better Auth client:
       - "use client" directive at top
       - Form with name, email, and password fields
       - Calls `authClient.signUp.email({ name, email, password })` on submit
       - Shows loading state during submission
       - On success, redirects to `/dashboard` using `router.push`
       - Shows error message if sign-up fails
       - Link to sign-in page at bottom
       - Use basic Tailwind v4 styling (no shadcn/ui components yet — those will be added when needed)
       - Style mobile-first: full-width inputs, large touch targets (min 44px height)

    4. Create `src/app/(auth)/sign-in/page.tsx` — sign-in form:
       - "use client" directive at top
       - Form with email and password fields
       - Calls `authClient.signIn.email({ email, password })` on submit
       - Shows loading state during submission
       - On success, redirects to `/dashboard` using `router.push`
       - Shows error message on invalid credentials
       - Link to sign-up page at bottom
       - Same mobile-first Tailwind styling as sign-up

    5. Create `src/app/(app)/layout.tsx` — the protected layout that gates all app routes:
       ```tsx
       import { auth } from "@/lib/auth";
       import { headers } from "next/headers";
       import { redirect } from "next/navigation";

       export default async function AppLayout({ children }: { children: React.ReactNode }) {
         const session = await auth.api.getSession({
           headers: await headers(), // MUST await headers() in Next.js 16
         });

         if (!session) {
           redirect("/sign-in");
         }

         return <>{children}</>;
       }
       ```
       CRITICAL: `headers()` must be awaited. Next.js 16 removed the sync compatibility shim.

    6. Create `src/app/(app)/dashboard/page.tsx` — a simple authenticated dashboard:
       - Server component that displays "Welcome to Paintr" and the user's email
       - Gets session from `auth.api.getSession({ headers: await headers() })`
       - Shows a sign-out button (client component island) that calls `authClient.signOut()`
       - This is a placeholder — real dashboard comes in later phases
  </action>
  <verify>
    Run `pnpm dev` and test the following flow:
    1. Visit localhost:3000/dashboard — should redirect to /sign-in
    2. Visit localhost:3000/sign-up — form should render
    3. Visit localhost:3000/sign-in — form should render
    Run `pnpm exec tsc --noEmit` to confirm no type errors in the new files.
  </verify>
  <done>Sign-up and sign-in pages render with forms, proxy redirects unauthenticated users to sign-in, protected app layout checks session server-side, dashboard page exists behind auth gate.</done>
</task>

</tasks>

<verification>
1. `pnpm dev` starts without errors
2. Navigating to /dashboard while unauthenticated redirects to /sign-in
3. Sign-up form renders at /sign-up with email/password fields
4. Sign-in form renders at /sign-in with email/password fields
5. `pnpm exec tsc --noEmit` passes
6. Auth schema tables exist in Supabase (user, session, account, verification)
7. Creating an account via /sign-up succeeds and redirects to dashboard
8. Closing and reopening the browser maintains the session (AUTH-02)
</verification>

<success_criteria>
A user can register with email and password, sign in, see the dashboard, and maintain their session across browser refresh. Unauthenticated users are redirected to the sign-in page.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
