---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/lib/auth.ts
  - src/lib/auth-client.ts
  - src/lib/db/schema/auth.ts
  - src/lib/db/schema/index.ts
  - src/app/(auth)/accept-invitation/[id]/page.tsx
  - src/app/(app)/dashboard/page.tsx
  - src/app/(app)/create-org/page.tsx
  - src/lib/email.ts
autonomous: true
requirements:
  - AUTH-03
  - AUTH-04
  - AUTH-05
  - AUTH-06
must_haves:
  truths:
    - "A user can create a new organization and becomes its owner"
    - "An owner can invite another user by email"
    - "An invited user receives an invitation email with a link"
    - "An invited user can accept the invitation and join the organization"
    - "The invited user is assigned the estimator role by default"
    - "Quotes created by Org A are invisible to users in Org B (RLS enforced)"
    - "An estimator can create and read quotes but cannot delete or share them"
  artifacts:
    - path: "src/lib/auth.ts"
      provides: "Better Auth server with organization plugin, roles, and access control"
      contains: "organization"
    - path: "src/lib/auth-client.ts"
      provides: "Better Auth client with organization client plugin"
      contains: "organizationClient"
    - path: "src/lib/email.ts"
      provides: "Email sending utility for invitations"
      contains: "resend"
    - path: "src/app/(auth)/accept-invitation/[id]/page.tsx"
      provides: "Invitation acceptance page"
      contains: "acceptInvitation"
    - path: "src/app/(app)/create-org/page.tsx"
      provides: "Organization creation page"
      contains: "organization.create"
    - path: "src/lib/db/schema/auth.ts"
      provides: "Updated auth schema with organization tables"
  key_links:
    - from: "src/lib/auth.ts"
      to: "src/lib/email.ts"
      via: "sendInvitationEmail callback"
      pattern: "sendInvitationEmail"
    - from: "src/app/(auth)/accept-invitation/[id]/page.tsx"
      to: "src/lib/auth-client.ts"
      via: "acceptInvitation client call"
      pattern: "organization\\.acceptInvitation"
    - from: "src/app/(app)/create-org/page.tsx"
      to: "src/lib/auth-client.ts"
      via: "organization.create client call"
      pattern: "organization\\.create"
    - from: "src/app/(app)/dashboard/page.tsx"
      to: "src/lib/auth.ts"
      via: "session with activeOrganizationId"
      pattern: "activeOrganizationId"
user_setup:
  - service: resend
    why: "Sending invitation emails to team members"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard (resend.com) -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sender domain or use default onboarding@resend.dev for testing"
        location: "Resend Dashboard -> Domains"
  - service: supabase
    why: "Enable RLS on quotes table and verify org isolation"
    env_vars: []
    dashboard_config:
      - task: "Ensure RLS is enabled on the quotes table after migration"
        location: "Supabase Dashboard -> Table Editor -> quotes -> RLS Policies"
---

<objective>
Add the organization plugin to Better Auth with custom owner and estimator roles, implement organization creation and invitation flows, set up email sending for invitations, and verify RLS tenant isolation on the quotes table.

Purpose: This delivers the core multi-tenancy features (AUTH-03, AUTH-04, AUTH-06) and data isolation (AUTH-05). Painters can form teams, invite colleagues, and be confident their data is private.
Output: Working organization creation, member invitation via email, invitation acceptance, role-based access control, and RLS-enforced tenant isolation.
</objective>

<execution_context>
@C:/Users/MarcBruins/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/MarcBruins/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add organization plugin with roles, email utility, and re-generate auth schema</name>
  <files>
    src/lib/auth.ts
    src/lib/auth-client.ts
    src/lib/email.ts
    src/lib/db/schema/auth.ts
    src/lib/db/schema/index.ts
  </files>
  <action>
    1. Create `src/lib/email.ts` — email sending utility using Resend:
       ```typescript
       import { Resend } from "resend";

       const resend = new Resend(process.env.RESEND_API_KEY);

       export async function sendInvitationEmail({
         to,
         inviterName,
         organizationName,
         inviteLink,
       }: {
         to: string;
         inviterName: string;
         organizationName: string;
         inviteLink: string;
       }) {
         await resend.emails.send({
           from: process.env.EMAIL_FROM || "Paintr <onboarding@resend.dev>",
           to,
           subject: `You've been invited to ${organizationName} on Paintr`,
           html: `
             <h2>Team Invitation</h2>
             <p>${inviterName} invited you to join <strong>${organizationName}</strong> on Paintr.</p>
             <p><a href="${inviteLink}" style="display:inline-block;padding:12px 24px;background:#2563eb;color:white;text-decoration:none;border-radius:6px;">Accept Invitation</a></p>
             <p>Or copy this link: ${inviteLink}</p>
           `,
         });
       }
       ```

    2. Update `src/lib/auth.ts` — add organization plugin with access control:
       ```typescript
       import { betterAuth } from "better-auth";
       import { drizzleAdapter } from "better-auth/adapters/drizzle";
       import { organization } from "better-auth/plugins";
       import { nextCookies } from "better-auth/next-js";
       import { createAccessControl } from "better-auth/plugins/access";
       import { db } from "./db";
       import { sendInvitationEmail } from "./email";

       const statement = {
         quote: ["create", "read", "update", "delete", "share"],
       } as const;

       const ac = createAccessControl(statement);

       const owner = ac.newRole({
         quote: ["create", "read", "update", "delete", "share"],
       });

       const estimator = ac.newRole({
         quote: ["create", "read", "update"],
       });

       export const auth = betterAuth({
         database: drizzleAdapter(db, { provider: "pg" }),
         emailAndPassword: { enabled: true },
         plugins: [
           organization({
             ac,
             roles: { owner, estimator },
             creatorRole: "owner",
             async sendInvitationEmail(data) {
               const inviteLink = `${process.env.BETTER_AUTH_URL}/accept-invitation/${data.id}`;
               await sendInvitationEmail({
                 to: data.email,
                 inviterName: data.inviter?.user?.name || "A team member",
                 organizationName: data.organization.name,
                 inviteLink,
               });
             },
           }),
           nextCookies(), // MUST be last plugin
         ],
         session: {
           cookieCache: {
             enabled: true,
             maxAge: 5 * 60,
           },
         },
       });

       export type Session = typeof auth.$Infer.Session;
       ```
       CRITICAL: `nextCookies()` MUST remain the last plugin in the array.

    3. Update `src/lib/auth-client.ts` — add organization client plugin:
       ```typescript
       import { createAuthClient } from "better-auth/react";
       import { organizationClient } from "better-auth/client/plugins";

       export const authClient = createAuthClient({
         baseURL: process.env.NEXT_PUBLIC_APP_URL,
         plugins: [organizationClient()],
       });

       export const { signIn, signUp, signOut, useSession, organization } = authClient;
       ```

    4. Re-generate the Better Auth schema to include organization tables:
       ```bash
       npx @better-auth/cli@latest generate --output src/lib/db/schema/auth.ts
       ```
       This will add organization, member, and invitation tables to the schema.

    5. Update `src/lib/db/schema/index.ts` to ensure both auth and app schemas are exported.

    6. Generate and apply the Drizzle migration for the new organization tables:
       ```bash
       pnpm db:generate
       pnpm db:migrate
       ```

    7. After migration, verify that RLS is enabled on the quotes table. If the Drizzle pgPolicy was not applied automatically during migration, run this SQL via the Supabase SQL editor or a migration:
       ```sql
       ALTER TABLE quotes ENABLE ROW LEVEL SECURITY;
       -- The policy from the Drizzle schema should exist; if not, create it:
       -- CREATE POLICY "org_isolation" ON quotes FOR ALL
       --   USING (organization_id = current_setting('app.current_org_id', true)::uuid)
       --   WITH CHECK (organization_id = current_setting('app.current_org_id', true)::uuid);
       CREATE INDEX IF NOT EXISTS idx_quotes_organization_id ON quotes(organization_id);
       ```
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to confirm no type errors. Run `pnpm db:generate` to verify schema is in sync. Check that `src/lib/db/schema/auth.ts` now contains organization-related tables (organization, member, invitation).
  </verify>
  <done>Better Auth configured with organization plugin, custom owner/estimator roles, invitation email via Resend, auth schema regenerated and migrated with org tables.</done>
</task>

<task type="auto">
  <name>Task 2: Create organization and invitation UI pages, update dashboard for org context</name>
  <files>
    src/app/(app)/create-org/page.tsx
    src/app/(auth)/accept-invitation/[id]/page.tsx
    src/app/(app)/dashboard/page.tsx
  </files>
  <action>
    1. Create `src/app/(app)/create-org/page.tsx` — organization creation page:
       - "use client" directive
       - Form with organization name and slug fields
       - Slug auto-generated from name (lowercase, hyphens, no spaces)
       - Calls `authClient.organization.create({ name, slug })` on submit
       - On success, calls `authClient.organization.setActive({ organizationId: data.id })` and redirects to `/dashboard`
       - Shows error if creation fails
       - Mobile-first Tailwind styling

    2. Create `src/app/(auth)/accept-invitation/[id]/page.tsx` — invitation acceptance page:
       - "use client" directive
       - Reads invitation ID from URL params (use `React.use(params)` for Next.js 16 async params)
       - On mount or button click, calls `authClient.organization.acceptInvitation({ invitationId })`
       - If user is not signed in, redirect to `/sign-in?redirect=/accept-invitation/{id}` so they can sign in first
       - On success, calls `authClient.organization.setActive()` with the org ID and redirects to `/dashboard`
       - Shows error state if invitation is expired or invalid
       - Mobile-first styling

    3. Update `src/app/(app)/dashboard/page.tsx`:
       - Show current organization name if user has an active organization
       - Show a "Create Organization" button/link if no active organization
       - Show an "Invite Team Member" section for org owners:
         - Email input + role dropdown (owner/estimator) + "Send Invite" button
         - Calls `authClient.organization.inviteMember({ email, role, organizationId })`
         - Shows success/error feedback
       - Show list of current organization members with their roles
       - The invite section and member list should be client component islands within the server component page
       - Keep it functional, not polished — styling improvements come in Phase 3 UX work

    4. Handle the redirect-after-auth flow:
       - Update sign-in page to check for `redirect` query parameter
       - After successful sign-in, redirect to the `redirect` param URL if present, otherwise to `/dashboard`
       - This ensures the accept-invitation flow works when the user needs to sign in first

    IMPORTANT for Next.js 16: Route params are async. In dynamic routes like `[id]`, access params via `React.use(params)` in client components or `await params` in server components. Do NOT destructure params synchronously.
  </action>
  <verify>
    Run `pnpm dev` and test:
    1. Sign in as an existing user
    2. Navigate to /create-org — form should render
    3. Create an organization — should redirect to dashboard showing org name
    4. Dashboard should show invite section for the org owner
    Run `pnpm exec tsc --noEmit` to confirm no type errors.
  </verify>
  <done>Organization creation page works, accept-invitation page handles the invite flow, dashboard shows org context with invite functionality for owners, redirect-after-auth flow enables invitation acceptance for new users.</done>
</task>

</tasks>

<verification>
1. Create a new user account via /sign-up
2. Navigate to /create-org, create "Test Painting Co."
3. Dashboard shows "Test Painting Co." as active organization
4. Enter an email in the invite form and send invitation
5. Check that invitation email is sent (verify in Resend dashboard or logs)
6. In an incognito window, sign up as a second user
7. Navigate to the invitation accept link from the email
8. Second user joins the organization with estimator role
9. Dashboard shows both members with correct roles (owner, estimator)
10. RLS: Create a quote as Org A, verify Org B user cannot see it (manual SQL or server action test)
</verification>

<success_criteria>
Users can create organizations, invite team members via email, accept invitations, and see shared data within their organization. Owner and estimator roles are enforced. Data from one organization is invisible to another via RLS.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
